name: Video Factory
name: Video Factory

# Déclenché par n8n (via workflow_dispatch)
on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Le prompt IA pour générer le script'
        required: true
        default: 'Les 5 faits les plus surprenants sur l'IA'
      titre:
        description: 'Le titre de travail'
        required: true
        default: 'Vidéo IA'

jobs:
  # Étape 1: Générer le scénario complet
  generate_script:
    runs-on: ubuntu-latest
    outputs:
      script_json_path: ${{ steps.upload_script.outputs.artifact_path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Run script generation
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          USER_PROMPT: ${{ github.event.inputs.prompt }}
        run: python scripts/1_generate_script.py

      - name: Upload script artifact
        id: upload_script
        uses: actions/upload-artifact@v3
        with:
          name: script-json
          path: video_script.json

  # Étape 2: Générer l'audio (TTS)
  generate_audio:
    runs-on: ubuntu-latest
    needs: generate_script
    steps:
      - name: Download script
        uses: actions/download-artifact@v3
        with:
          name: script-json

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      - name: Run TTS generation
        env:
          ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
        run: python scripts/2_generate_audio.py
      
      - name: Upload audio files
        uses: actions/upload-artifact@v3
        with:
          name: audio-files
          path: audio/

  # Étape 3: Trouver les vidéos B-Roll
  generate_broll:
    runs-on: ubuntu-latest
    needs: generate_script
    steps:
      - name: Download script
        uses: actions/download-artifact@v3
        with:
          name: script-json

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      - name: Run B-roll finder
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: python scripts/3_find_broll.py
      
      - name: Upload video files
        uses: actions/upload-artifact@v3
        with:
          name: video-files
          path: videos/

  # Étape 4: Compiler la vidéo finale
  compile_video:
    runs-on: ubuntu-latest
    needs: [generate_audio, generate_broll]
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
      
      - name: Install FFmpeg ( requis par moviepy )
        uses: FedericoCarboni/setup-ffmpeg@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts/
      
      - name: Re-organize artifacts
        run: |
          mkdir -p audio/ videos/
          mv artifacts/audio-files/* audio/
          mv artifacts/video-files/* videos/
          mv artifacts/script-json/video_script.json .

      - name: Run video compilation
        run: python scripts/4_compile_video.py

      - name: Upload final video
        uses: actions/upload-artifact@v3
        with:
          name: final_video # Doit correspondre au nœud n8n "Download Artifact"
          path: final_video.mp4
